<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Event - Zen Bali</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo"><span>ðŸŒ´</span><span>Zen Bali</span></a>
                <nav class="nav">
                    <a href="/creator/dashboard.html" class="nav-link">Dashboard</a>
                    <a href="/creator/events.html" class="nav-link">My Events</a>
                    <a href="/creator/new-event.html" class="nav-link active">Post Event</a>
                    <a href="#" class="nav-link" onclick="Auth.logout(); return false;">Logout</a>
                </nav>
            </div>
        </div>
    </header>

    <main style="padding: 2rem 0;">
        <div class="container" style="max-width: 700px;">
            <div class="card">
                <div class="card-header">
                    <h1 class="card-title">Post New Event</h1>
                    <p class="text-muted mt-1">Create your event listing - $10 USD to publish</p>
                </div>
                <div class="card-body">
                    <div id="alertContainer"></div>
                    
                    <form id="eventForm">
                        <div class="form-group">
                            <label class="form-label">Event Title <span class="required">*</span></label>
                            <input type="text" name="title" class="form-control" required 
                                   placeholder="e.g., Full Moon Yoga Retreat">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Event Date <span class="required">*</span></label>
                                <input type="date" name="event_date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Event Time</label>
                                <input type="time" name="event_time" class="form-control">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Location <span class="required">*</span></label>
                            <select name="location_id" class="form-control" required id="locationSelect">
                                <option value="">Select location...</option>
                            </select>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Event Type <span class="required">*</span></label>
                                <select name="event_type_id" class="form-control" required id="eventTypeSelect">
                                    <option value="">Select type...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration</label>
                                <input type="text" name="duration" class="form-control" 
                                       placeholder="e.g., 2 hours, Full day">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Entrance Type <span class="required">*</span></label>
                                <select name="entrance_type_id" class="form-control" required id="entranceTypeSelect">
                                    <option value="">Select type...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Entrance Fee (USD)</label>
                                <input type="number" name="entrance_fee" class="form-control" 
                                       min="0" step="0.01" value="0" placeholder="0 for free events">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Contact Email <span class="required">*</span></label>
                                <input type="email" name="contact_email" class="form-control" required 
                                       placeholder="contact@example.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Mobile</label>
                                <input type="tel" name="contact_mobile" class="form-control" 
                                       placeholder="+62 812 345 6789">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Event Description</label>
                            <textarea name="notes" class="form-control" rows="5" 
                                      placeholder="Describe your event, what to expect, what to bring..."></textarea>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                Create Event
                            </button>
                            <a href="/creator/dashboard.html" class="btn btn-secondary btn-lg">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h4 style="color: var(--primary);">ðŸ“¸ Add Event Image</h4>
                    <p class="text-muted mb-0">
                        You can upload an event image after creating the event. Images help attract more attendees!
                    </p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container"><div class="footer-content">
            <div class="footer-credit">Developed by <a href="https://net1io.com" target="_blank">net1io.com</a><br>Copyright &copy; 2024</div>
        </div></div>
    </footer>

    <script src="/js/main.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            requireAuth();
            loadFormOptions();

            // Pre-fill contact email
            const user = Auth.getUser();
            if (user && user.email) {
                document.querySelector('[name="contact_email"]').value = user.email;
            }

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('[name="event_date"]').min = today;

            document.getElementById('eventForm').addEventListener('submit', handleSubmit);
        });

        async function loadFormOptions() {
            try {
                const [locResponse, typeResponse, entranceResponse] = await Promise.all([
                    API.get('/locations'),
                    API.get('/event-types'),
                    API.get('/entrance-types')
                ]);

                if (locResponse.success) {
                    const select = document.getElementById('locationSelect');
                    locResponse.data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name;
                        select.appendChild(option);
                    });
                }

                if (typeResponse.success) {
                    const select = document.getElementById('eventTypeSelect');
                    typeResponse.data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name;
                        select.appendChild(option);
                    });
                }

                if (entranceResponse.success) {
                    const select = document.getElementById('entranceTypeSelect');
                    entranceResponse.data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load form options:', error);
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Creating...';

            try {
                const form = e.target;
                const data = {
                    title: form.title.value,
                    event_date: form.event_date.value,
                    event_time: form.event_time.value,
                    location_id: parseInt(form.location_id.value),
                    event_type_id: parseInt(form.event_type_id.value),
                    duration: form.duration.value,
                    entrance_type_id: parseInt(form.entrance_type_id.value),
                    entrance_fee: parseFloat(form.entrance_fee.value) || 0,
                    contact_email: form.contact_email.value,
                    contact_mobile: form.contact_mobile.value,
                    notes: form.notes.value
                };

                const response = await API.post('/creator/events', data);
                
                if (response.success) {
                    // Redirect to edit page to add image and pay
                    window.location.href = `/creator/edit-event.html?id=${response.data.id}&new=1`;
                }
            } catch (error) {
                document.getElementById('alertContainer').innerHTML = 
                    `<div class="alert alert-error">${error.message}</div>`;
                btn.disabled = false;
                btn.textContent = 'Create Event';
            }
        }
    </script>
</body>
</html>
