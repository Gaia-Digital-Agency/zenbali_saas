<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Event - Zen Bali</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo"><span>ðŸŒ´</span><span>Zen Bali</span></a>
                <nav class="nav">
                    <a href="/creator/dashboard.html" class="nav-link">Dashboard</a>
                    <a href="/creator/events.html" class="nav-link">My Events</a>
                    <a href="/creator/new-event.html" class="nav-link active">Post Event</a>
                    <a href="#" class="nav-link" onclick="Auth.logout(); return false;">Logout</a>
                </nav>
            </div>
        </div>
    </header>

    <main style="padding: 2rem 0;">
        <div class="container" style="max-width: 700px;">
            <div class="card">
                <div class="card-header">
                    <h1 class="card-title">Post New Event</h1>
                    <p class="text-muted mt-1">Create your event listing - $10 USD to publish</p>
                </div>
                <div class="card-body">
                    <div id="alertContainer"></div>
                    
                    <form id="eventForm">
                        <div class="form-group">
                            <label class="form-label">Event Title <span class="required">*</span></label>
                            <input type="text" name="title" class="form-control" required 
                                   placeholder="e.g., Full Moon Yoga Retreat">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Event Date <span class="required">*</span></label>
                                <input type="date" name="event_date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Event Time (15 min increments) <span class="required">*</span></label>
                                <select name="event_time" class="form-control" id="eventTimeSelect" required>
                                    <option value="">Select time...</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Location <span class="required">*</span></label>
                            <select name="location_id" class="form-control" required id="locationSelect">
                                <option value="">Select location...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Event Type <span class="required">*</span></label>
                            <select name="event_type_id" class="form-control" required id="eventTypeSelect">
                                <option value="">Select type...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Duration (15 min increments) <span class="required">*</span></label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                                <div>
                                    <label class="form-label" style="font-size: 0.875rem;">Days</label>
                                    <select name="duration_days" class="form-control" id="durationDays" required>
                                        <option value="0">00</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 0.875rem;">Hours</label>
                                    <select name="duration_hours" class="form-control" id="durationHours" required>
                                        <option value="1">1</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 0.875rem;">Minutes</label>
                                    <select name="duration_minutes" class="form-control" id="durationMinutes" required>
                                        <option value="0">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Entrance Type <span class="required">*</span></label>
                            <select name="entrance_type_id" class="form-control" required id="entranceTypeSelect">
                                <option value="">Select type...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Entrance Fee (Rupiah '000)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 0.5rem;">
                                <div>
                                    <label class="form-label" style="font-size: 0.875rem;">10K - 90K</label>
                                    <select name="fee_10k" class="form-control" id="fee10k">
                                        <option value="0">0</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 0.875rem;">1K - 9K</label>
                                    <select name="fee_1k" class="form-control" id="fee1k">
                                        <option value="0">0</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 0.875rem;">100 - 900</label>
                                    <select name="fee_100" class="form-control" id="fee100">
                                        <option value="0">0</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 0.875rem;">10 - 90</label>
                                    <select name="fee_10" class="form-control" id="fee10">
                                        <option value="0">0</option>
                                    </select>
                                </div>
                            </div>
                            <input type="text" name="fee_verbatim" class="form-control mt-2" id="feeVerbatim"
                                   placeholder="For Rp 100 million and above, enter amount here">
                            <input type="hidden" name="entrance_fee" id="entranceFeeHidden">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Participant Group Type <span class="required">*</span></label>
                                <select name="participant_group_type" class="form-control" id="participantGroupType" required>
                                    <option value="">Select group type...</option>
                                    <option value="Couples">Couples</option>
                                    <option value="Females Only">Females Only</option>
                                    <option value="Males Only">Males Only</option>
                                    <option value="Open">Open</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lead By <span class="required">*</span></label>
                                <input type="text" name="lead_by" class="form-control" required
                                       placeholder="e.g., John Smith, Certified Instructor">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Contact Email <span class="required">*</span></label>
                                <input type="email" name="contact_email" class="form-control" required 
                                       placeholder="contact@example.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Mobile <span class="required">*</span></label>
                                <input type="tel" name="contact_mobile" class="form-control" required
                                       placeholder="+62 812 345 6789">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Event Description <span class="required">*</span></label>
                            <textarea name="notes" class="form-control" rows="5" required
                                      placeholder="Describe your event, what to expect, what to bring..."></textarea>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                Create Event
                            </button>
                            <a href="/creator/dashboard.html" class="btn btn-secondary btn-lg">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h4 style="color: var(--primary);">ðŸ“¸ Add Event Image</h4>
                    <p class="text-muted mb-0">
                        You can upload an event image after creating the event. Images help attract more attendees!
                    </p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container"><div class="footer-content">
            <div class="footer-credit">Developed by <a href="https://net1io.com" target="_blank">net1io.com</a><br>Copyright &copy; 2024</div>
        </div></div>
    </footer>

    <script src="/js/main.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            requireAuth();
            loadFormOptions();
            populateTimeDropdown();
            populateDurationDropdowns();
            populateFeeDropdowns();
            setupFeeCalculation();

            // Pre-fill contact email
            const user = Auth.getUser();
            if (user && user.email) {
                document.querySelector('[name="contact_email"]').value = user.email;
            }

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('[name="event_date"]').min = today;

            document.getElementById('eventForm').addEventListener('submit', handleSubmit);
        });

        function populateTimeDropdown() {
            const select = document.getElementById('eventTimeSelect');
            for (let hour = 0; hour < 24; hour++) {
                for (let min = 0; min < 60; min += 15) {
                    const h = String(hour).padStart(2, '0');
                    const m = String(min).padStart(2, '0');
                    const option = document.createElement('option');
                    option.value = `${h}:${m}:00`;
                    option.textContent = `${h}:${m}`;
                    select.appendChild(option);
                }
            }
        }

        function populateDurationDropdowns() {
            // Days: 0 only (default)
            const daysSelect = document.getElementById('durationDays');
            for (let i = 0; i <= 0; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = String(i).padStart(2, '0');
                if (i === 0) option.selected = true;
                daysSelect.appendChild(option);
            }

            // Hours: 1-23
            const hoursSelect = document.getElementById('durationHours');
            for (let i = 1; i <= 23; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === 1) option.selected = true;
                hoursSelect.appendChild(option);
            }
        }

        function populateFeeDropdowns() {
            // 10K-90K (10000, 20000, ..., 90000)
            const fee10k = document.getElementById('fee10k');
            for (let i = 0; i <= 9; i++) {
                const option = document.createElement('option');
                option.value = i * 10000;
                option.textContent = i * 10;
                fee10k.appendChild(option);
            }

            // 1K-9K (1000, 2000, ..., 9000)
            const fee1k = document.getElementById('fee1k');
            for (let i = 0; i <= 9; i++) {
                const option = document.createElement('option');
                option.value = i * 1000;
                option.textContent = i;
                fee1k.appendChild(option);
            }

            // 100-900 (100, 200, ..., 900)
            const fee100 = document.getElementById('fee100');
            for (let i = 0; i <= 9; i++) {
                const option = document.createElement('option');
                option.value = i * 100;
                option.textContent = i;
                fee100.appendChild(option);
            }

            // 10-90 (10, 20, ..., 90)
            const fee10 = document.getElementById('fee10');
            for (let i = 0; i <= 9; i++) {
                const option = document.createElement('option');
                option.value = i * 10;
                option.textContent = i;
                fee10.appendChild(option);
            }
        }

        function setupFeeCalculation() {
            const selects = ['fee10k', 'fee1k', 'fee100', 'fee10'];
            selects.forEach(id => {
                document.getElementById(id).addEventListener('change', calculateTotalFee);
            });
            document.getElementById('feeVerbatim').addEventListener('input', handleVerbatimFee);
        }

        function calculateTotalFee() {
            const fee10k = parseInt(document.getElementById('fee10k').value) || 0;
            const fee1k = parseInt(document.getElementById('fee1k').value) || 0;
            const fee100 = parseInt(document.getElementById('fee100').value) || 0;
            const fee10 = parseInt(document.getElementById('fee10').value) || 0;

            const total = fee10k + fee1k + fee100 + fee10;
            document.getElementById('entranceFeeHidden').value = total;
        }

        function handleVerbatimFee() {
            const verbatim = document.getElementById('feeVerbatim').value.trim();
            if (verbatim) {
                const amount = parseFloat(verbatim.replace(/[^0-9.]/g, ''));
                if (!isNaN(amount) && amount >= 100000000) {
                    document.getElementById('entranceFeeHidden').value = amount;
                    // Clear dropdowns
                    ['fee10k', 'fee1k', 'fee100', 'fee10'].forEach(id => {
                        document.getElementById(id).value = '0';
                    });
                }
            } else {
                calculateTotalFee();
            }
        }

        async function loadFormOptions() {
            try {
                const [locResponse, typeResponse, entranceResponse] = await Promise.all([
                    API.get('/locations'),
                    API.get('/event-types'),
                    API.get('/entrance-types')
                ]);

                if (locResponse.success) {
                    const select = document.getElementById('locationSelect');
                    locResponse.data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name;
                        select.appendChild(option);
                    });
                }

                if (typeResponse.success) {
                    const select = document.getElementById('eventTypeSelect');
                    typeResponse.data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name;
                        select.appendChild(option);
                    });
                }

                if (entranceResponse.success) {
                    const select = document.getElementById('entranceTypeSelect');
                    entranceResponse.data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load form options:', error);
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Creating...';

            try {
                const form = e.target;

                // Calculate final entrance fee
                calculateTotalFee();

                // Build duration string
                const days = form.duration_days.value;
                const hours = form.duration_hours.value;
                const mins = form.duration_minutes.value;
                let duration = '';
                if (parseInt(days) > 0) duration += `${days} day${days > 1 ? 's' : ''} `;
                if (parseInt(hours) > 0) duration += `${hours} hour${hours > 1 ? 's' : ''} `;
                if (parseInt(mins) > 0) duration += `${mins} min${mins > 1 ? 's' : ''}`;
                duration = duration.trim();

                const data = {
                    title: form.title.value,
                    event_date: form.event_date.value,
                    event_time: form.event_time.value,
                    location_id: parseInt(form.location_id.value),
                    event_type_id: parseInt(form.event_type_id.value),
                    duration: duration,
                    entrance_type_id: parseInt(form.entrance_type_id.value),
                    entrance_fee: parseFloat(form.entrance_fee.value) || 0,
                    participant_group_type: form.participant_group_type.value,
                    lead_by: form.lead_by.value,
                    contact_email: form.contact_email.value,
                    contact_mobile: form.contact_mobile.value,
                    notes: form.notes.value
                };

                const response = await API.post('/creator/events', data);

                if (response.success) {
                    // Redirect to edit page to add image and pay
                    window.location.href = `/creator/edit-event.html?id=${response.data.id}&new=1`;
                }
            } catch (error) {
                document.getElementById('alertContainer').innerHTML =
                    `<div class="alert alert-error">${error.message}</div>`;
                btn.disabled = false;
                btn.textContent = 'Create Event';
            }
        }
    </script>
</body>
</html>
